---
title: 'Tipología y ciclo de vida de los datos: Práctica2'
author: "Antonio Guzmán Martín"
date: "Diciembre 2017"
output:
  pdf_document:
    toc: yes
    toc_depth: '2'
  html_document:
    highlight: default
    number_sections: yes
    theme: cosmo
    toc: yes
    toc_depth: 2
---

```{r}
library(readr)
wine_red <- read.csv(file="winequality-red.csv", header = TRUE)

#numero de filas por dataset
nrow(wine_red)
ncol<-ncol(wine_red)
#sacamos 5 primeras filas
head(wine_red[,1:ncol])

sapply(wine_red,class)
```
# 1. Descripción del dataset


**Variables del dataset**


* **fixed acidity:** Conjunto de los ácidos naturales procedentes de la uva (tartárico, málico, cítrico y succínico) o formados en la fermentación maloláctica (láctico). En general, los ácidos (acidez fija) son preservante naturales del vino y ayuda a mantener el color y cualidades aromáticas. 

* **volatile acidity:** Conjunto de ácidos formados durante la fermentación o como consecuencia de alteraciones microbianas. Estos ácidos son, principalmente: ácido Acético, ácido Propionico, ácido Butírico y ácido Sulfúrico. Si la acidez volátil, presente en todos los vinos, es muy elevada el vino se picará y avigranará con el paso del tiempo. Es conveniente que la acidez volatil de un vino sea lo más baja posible.

El contenido en acidez volátil no puede ser superior a:
a) 18 miliequivalentes por litro para los mostos de uva parcialmente fermentados,
b) 18 miliequivalentes por litro para los vinos blancos y rosados,
c) 20 miliequivalentes por litro para los vinos tintos.


* **citric acid:** En pequeñas cantidades este hacido puede añadir frescor y sabor a los vinos (dentro de acido fijo)

* **residual sugar:** Azúcar que queda en el vino después de la fermentación. Es raro encontrar vinos con menos de  1 g/l y vinos con más de  45 g/l son considerados dulces
* **chlorides:** cantidad de sal en el vino
* **free sulfur dioxide :** Previene del crecimiento microbial y de la oxidación del vino.La oxidación enturbia sus colores característicos (tornándolos en amarillos intensos e, incluso, marrones).Por lo que respecta al gusto, al beberlo notaremos sabores más secos y ásperos, incluso amargos en algunos casos.

* **total sulfur dioxide:** suma de concentraciones libres y amarradas de S02; concentraciones de dioxodo de sulfuro libres superiores a  50 ppm se vuelven evidentes en el sabor y olor
* **density:** densidad del vino, suele ser similar al del agua dependiendo de la concentración de azucar y alcohol
* **pH:** Describe como de ácido o básico es el vino 0 (very acidic) to 14 (very basic); mayoria vinos en escala 3-4.(principalmente 3,55 a 4)
* **sulphates:** Actua como un antimicrobial and antioxidante. Los sulfatos de sodio y calcio aparecen en el agua y por lo tanto la uva y el vino pueden contenerlos. Un agua con una cantidad de sulfatos inferior a 250mg/l se considera en este aspecto un agua de calidad y con valores superiores a 400mg/l insalubre.

* **alcohol:** cantidad de alcohol del vino. No es muy útil para hallar la calidad
* **quality:** calidad del vino entre 0 y 10

## 1.1 ¿Por qué es importante y qué pregunta/problema pretende responder?

Pregunta: ¿Qué componentes fisico-químicos influyen en que un vino sea bueno?. Obtener un modelo cuya combinación de variables permita determinar si es un buen vino.


# 2. Integración y selección de los datos de interés a analizar.

La mayoría de los atributos corresponden con características necesarias para determinar la calidad del vino. 

Sin embargo, a priori, podemos prescindir de la variable `total sulfur dioxide` (indica elsuma de concentraciones libres y amarradas, solo nos interesan las libres) y `density` (indica proporción de alcohol y esta no es interesante para determinar la calidad) (Según el estudio de: https://www.vinopack.es/criterios-que-determinan-la-calidad-en-el-vino).

No obstante, en los siguientes apartados comprobaremos si esto es cierto, o por el contrario si que afecta en la calidad.

# 3 Limpieza de datos

## 3.1 Elementos vacíos
```{r}
# Números de valores desconocidos por campo
sapply(wine_red, function(x) sum(is.na(x)))
#No se han encontrado valores vacíos o NAs. 

# Resumen de las variables
summary(wine_red)
#ph: correcto (entre 2 y 4)
```

## 3.2 Valores extremos
Para cada una de las variables observemos si existen valores atípicos:

```{r}
boxplot(wine_red$fixed.acidity,main = "fixed.acidity",col="gray")
boxplot.stats(wine_red$fixed.acidity)$out

boxplot(wine_red$volatile.acidity,main = "volatile",col="gray")
boxplot.stats(wine_red$volatile.acidity)$out

boxplot(wine_red$citric.acid,main = "citric.acid",col="gray")
boxplot.stats(wine_red$citric.acid)$out

boxplot(wine_red$residual.sugar,main = "residual.sugar",col="gray")
boxplot.stats(wine_red$residual.sugar)$out

boxplot(wine_red$chlorides,main = "chlorides",col="gray")
boxplot.stats(wine_red$residual.sugar)$out

boxplot(wine_red$chlorides,main = "residual.sugar",col="gray")
boxplot.stats(wine_red$residual.sugar)$out

boxplot(wine_red$free.sulfur.dioxide,main = "free.sulfur.dioxide",col="gray")
boxplot.stats(wine_red$free.sulfur.dioxide)$out


boxplot(wine_red$pH,main = "pH",col="gray")
boxplot.stats(wine_red$pH)$out
#datos correctos porque los valores de pH estan entre 2 y 7

boxplot(wine_red$sulphates,main = "sulphates",col="gray")
boxplot.stats(wine_red$sulphates)$out


boxplot(wine_red$ alcohol,main = " alcohol",col="gray")
boxplot.stats(wine_red$ alcohol)$out
#alcohol está dentro de unos rangos adecuados

```

Todas las gráficas presentan outliers pero dado a que, la creación de un vino es puramente una reacción química, se puede decir que los valores que se presentan son posibles y simplemente podemos decir que dichos vinos tienen características muy diferentes al resto.

# 4. Análisis de datos.

## 4.1 Selección de los grupos de datos que se quieren analizar/comparar (planificación de los análisis a aplicar).

Vamos a proceder a realizar 3 grupos. Un primer grupo de alto y bajo contenido de alcohol, otro segundo grupo de vinos más dulces y menos dulces y un último grupo de acidez volátil.

A continuación creamos la partición a partir del tercer cuartil de la variable `alcohol`:

```{r}
high_alcohol<-quantile(wine_red$alcohol, probs =0.75)
vinos.altoAlcohol<-wine_red[wine_red$alcohol>=high_alcohol,]$quality
vinos.bajoAlcohol<-wine_red[wine_red$alcohol<high_alcohol,]$quality
```

Variable `residual.sugar`:

```{r}
high_sugar<-quantile(wine_red$residual.sugar, probs =0.75)
vinos.altoGradoAzucar<-wine_red[wine_red$residual.sugar>=high_sugar,]$quality
vinos.bajoGradoAzucar<-wine_red[wine_red$residual.sugar<high_sugar,]$quality
```

Y finalmente, `volatile.acidity`:

```{r}
high_volatile.acidity<-quantile(wine_red$volatile.acidity, probs =0.75)
vinos.altoVolatile.acidity<-wine_red[wine_red$volatile.acidity>=high_volatile.acidity,]$quality
vinos.bajoVolatile.acidity<-wine_red[wine_red$volatile.acidity<high_volatile.acidity,]$quality
```


## 4.2 Comprobación de la normalidad y homogeneidad de la varianza
**Comprobar  que variables siguen distribución normal**

Aplicando la siguiente función podemos comprobar si siguen una distribución normal o si por el contrario no lo hacen.

```{r}
#install.packages("nortest")
library(nortest)

alpha = 0.05
col.names = colnames(wine_red)
for (i in 1:ncol(wine_red)) {
  if (i == 1) cat("Variables que no siguen una distribución normal:\n")
  if (is.integer(wine_red[,i]) | is.numeric(wine_red[,i])) {
      p_val = ad.test(wine_red[,i])$p.value
        if (p_val < alpha) {
            cat(col.names[i])
                  # Format output
            if (i < ncol(wine_red) - 1) cat(", ")
            if (i %% 3 == 0) cat("\n") 
        }
      } 
  }
```

Otra alternativa es aplicar la función *shapiro.test* y a partir del valor obtenido de p-valor podremos decir si es normal o no.

```{r}
shapiro.test(vinos$fixed.acidity)
shapiro.test(vinos$volatile.acidity)
shapiro.test(vinos$citric.acid)
shapiro.test(vinos$residual.sugar)
shapiro.test(vinos$chlorides)
shapiro.test(vinos$free.sulfur.dioxide)
shapiro.test(vinos$total.sulfur.dioxide)
shapiro.test(vinos$density)
shapiro.test(vinos$pH)
shapiro.test(vinos$sulphates)
shapiro.test(vinos$alcohol)
```

Como el p-valor es inferior al 0.05 podemos rechazar la hipótesis nula y decir que no es normal.


## 4.3 Aplicación de pruebas estadísticas para comparar los grupos de datos. En función de los datos y el objetivo del estudio, aplicar pruebas de contraste de hipótesis, correlaciones, regresiones, etc.

En primer lugar, procedemos a realizar un análisis de correlación entre las distintas variables para determinar cuáles de ellas ejercen una mayor influencia sobre la calidad del vino:


```{r}
corr_matrix <- matrix(nc = 2, nr = 0)
colnames(corr_matrix) <- c("estimate", "p-value")
# Calcular el coeficiente de correlación para cada variable cuantitativa # con respecto al campo "precio"
for (i in 1:(ncol(wine_red) - 1)) {
if (is.integer(wine_red[,i]) | is.numeric(wine_red[,i]))
    { 
    spearman_test = cor.test(wine_red[,i],wine_red[,length(wine_red)],method = "spearman")
      corr_coef = spearman_test$estimate
      p_val = spearman_test$p.value
      # Add row to matrix
    pair = matrix(ncol = 2, nrow = 1)
    pair[1][1] = corr_coef
    pair[2][1] = p_val
    corr_matrix <- rbind(corr_matrix, pair)
    rownames(corr_matrix)[nrow(corr_matrix)] <- colnames(wine_red)[i]
  } 
}

a <- corr_matrix[,'p-value']
corr_matrix[order(a),]
```

Así, identificamos cuáles son las variables más correlacionadas con la calidad según su proximidad con los valores -1 y +1.

Teniendo esto en cuenta, queda patente cómo la variable más relevante para **la calidad** es la variable `alcohol`. Pero en términos generales podemos decir que los valores que obtenemos son bastante modestos y no sería adecuado obtener ninguna conclusión por ahora. Lo único que podemos hacer es utilizar estos valores como tendencias.

Nota. Para cada coeficiente de correlación se muestra también su p-valor asociado, puesto que éste puede dar información acerca del peso estadístico de la correlación obtenida.

### Modelo de regresión lineal logística

Tal y como se planteó en los objetivos de la actividad, resultará de mucho interés poder realizar predicciones sobre la calidad del vino dadas sus características.
Así, se calculará un modelo de regresión lógistica utilizando regresores tanto cuantitativos como cualitativos con el que poder realizar las predicciones sobre la calidad.

**Se usa regresión logística ya que nuestro modelo predicirá si el vino es de calidad o no (variable dicotómica).**

Para obtener un modelo de regresión logística considerablemente eficiente, lo que haremos será obtener varios modelos de regresión utilizando las variables que estén más correladas con respecto a la calidad.

**DUDA: ¿Cómo saber cuantas variables coger: las 3, 4 o 5 primeras?¿Añado otra más que no esté en ese TOP? ¿Cómo averiguar si las variables están relacionadas y por tanto no debo añadir ambas? ¿Solo tengo como herramienta la información que tengo de las variables?**

```{r}

# Regresores cuantitativos con mayor coeficiente  de correlación con respecto al precio
alcohol = wine_red$alcohol
volatile.acidity = wine_red$volatile.acidity
sulphates=wine_red$sulphates
citric.acid=wine_red$citric.acid
total.sulfur.dioxide=wine_red$total.sulfur.dioxide
chlorides=wine_red$chlorides
density=wine_red$density
fixed.acidity=wine_red$fixed.acidity
free.sulfur.dioxide=wine_red$free.sulfur.dioxide  
pH=wine_red$pH
good_wine <-ifelse(test=wine_red$quality>=7,yes=1,no=0)
wine_red$good_wine=good_wine

GLM.1 <- glm( wine_red$good_wine ~ alcohol + volatile.acidity + sulphates + fixed.acidity, family=binomial(logit),data=wine_red)
#summary(GLM.1)
AIC_GLM1<-summary(GLM.1)$aic
#exp(coef(GLM.1))

GLM.2 <- glm( wine_red$good_wine ~ alcohol + volatile.acidity + sulphates + citric.acid, family=binomial(logit),data=wine_red)
#summary(GLM.2)
AIC_GLM2<-summary(GLM.2)$aic
#exp(coef(GLM.2))


GLM.3 <- glm( wine_red$good_wine ~ alcohol + volatile.acidity + sulphates + density, family=binomial(logit),data=wine_red)
AIC_GLM3<-summary(GLM.3)$aic


GLM.4 <- glm( wine_red$good_wine ~ alcohol + volatile.acidity + sulphates + total.sulfur.dioxide, family=binomial(logit),data=wine_red)
AIC_GLM4<-summary(GLM.4)$aic


GLM.5 <- glm( wine_red$good_wine ~ alcohol + volatile.acidity + sulphates + free.sulfur.dioxide  , family=binomial(logit),data=wine_red)
AIC_GLM5<-summary(GLM.5)$aic

GLM.6 <- glm( wine_red$good_wine ~ alcohol + volatile.acidity + sulphates + chlorides  , family=binomial(logit),data=wine_red)
AIC_GLM6<-summary(GLM.6)$aic

GLM.7 <- glm( wine_red$good_wine ~ alcohol + volatile.acidity + sulphates + pH  , family=binomial(logit),data=wine_red)
AIC_GLM7<-summary(GLM.7)$aic

# DUDA: ¿¿A MÁS VARIABLES ES MEJOR??
GLM.8 <- glm( wine_red$good_wine ~ alcohol + volatile.acidity + sulphates + total.sulfur.dioxide + citric.acid + free.sulfur.dioxide , family=binomial(logit),data=wine_red)
AIC_GLM8<-summary(GLM.8)$aic

AIC_GLM1
AIC_GLM2
AIC_GLM3
AIC_GLM4
AIC_GLM5
AIC_GLM6
AIC_GLM7
AIC_GLM8
p_model8 <- predict(GLM.8, type = 'response')
p_model4 <- predict(GLM.4, type = 'response')
summary(p_model4)
wine_red$prob<-p_model4
wine_red$prob2<-p_model8
pred <-ifelse(test=wine_red$prob>0.7,yes=1,no=0)
pred2 <-ifelse(test=wine_red$prob2>0.7,yes=1,no=0)
wine_red$pred=pred
wine_red$pred2=pred2
```

# 5. Representación de los resultados a partir de tablas y gráficas.

**Se observa una clara tendencia a que a más alcohol, mejor es la calidad**
```{r}
library(ggplot2)
ggplot(wine_red, aes(x = alcohol, y = fixed.acidity, color = wine_red$good_wine)) + geom_point()
aux=summary(wine_red$alcohol)
```
### Calculo curva ROC
El mejor modelo, el número 4 tan solo me da un AUC=0.5451, es bastante malo. 

```{r}

library(pROC)
#Cáculo curva
g<-roc(wine_red$good_wine,wine_red$pred)
g
#Área bajo la curva
auc(g)
plot(g) 
```