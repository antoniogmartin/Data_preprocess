---
title: 'Tipología y ciclo de vida de los datos: Práctica2'
author: "Antonio Guzmán Martín"
date: "Diciembre 2017"
output:
  pdf_document:
    toc: yes
    toc_depth: '2'
  html_document:
    highlight: default
    number_sections: yes
    theme: cosmo
    toc: yes
    toc_depth: 2
---

```{r}
library(readr)
wine_red <- read.csv(file="~/Desktop/Tipología\ y\ ciclo\ de\ vida\ de\ los\ datos/practica2/wine/winequality-red.csv", header = TRUE)

#numero de filas por dataset
nrow(wine_red)
ncol<-ncol(wine_red)
#sacamos 5 primeras filas
head(wine_red[,1:ncol])

sapply(wine_red,class)
```
# 1. Descripción del dataset


**Variables del dataset**


* **fixed acidity:** Conjunto de los ácidos naturales procedentes de la uva (tartárico, málico, cítrico y succínico) o formados en la fermentación maloláctica (láctico). En general, los ácidos (acidez fija) son preservante naturales del vino y ayuda a mantener el color y cualidades aromáticas. 

* **volatile acidity:** Conjunto de ácidos formados durante la fermentación o como consecuencia de alteraciones microbianas. Estos ácidos son, principalmente: ácido Acético, ácido Propionico, ácido Butírico y ácido Sulfúrico. Si la acidez volátil, presente en todos los vinos, es muy elevada el vino se picará y avigranará con el paso del tiempo. Es conveniente que la acidez volatil de un vino sea lo más baja posible.

El contenido en acidez volátil no puede ser superior a:
a) 18 miliequivalentes por litro para los mostos de uva parcialmente fermentados,
b) 18 miliequivalentes por litro para los vinos blancos y rosados,
c) 20 miliequivalentes por litro para los vinos tintos.


* **citric acid:** En pequeñas cantidades este hacido puede añadir frescor y sabor a los vinos (dentro de acido fijo)

* **residual sugar:** Azúcar que queda en el vino después de la fermentación. Es raro encontrar vinos con menos de  1 g/l y vinos con más de  45 g/l son considerados dulces
* **chlorides:** cantidad de sal en el vino
* **free sulfur dioxide :** Previene del crecimiento microbial y de la oxidación del vino.La oxidación enturbia sus colores característicos (tornándolos en amarillos intensos e, incluso, marrones).Por lo que respecta al gusto, al beberlo notaremos sabores más secos y ásperos, incluso amargos en algunos casos.

* **total sulfur dioxide:** suma de concentraciones libres y amarradas de S02; concentraciones de dioxodo de sulfuro libres superiores a  50 ppm se vuelven evidentes en el sabor y olor
* **density:** densidad del vino, suele ser similar al del agua dependiendo de la concentración de azucar y alcohol
* **pH:** Describe como de ácido o básico es el vino 0 (very acidic) to 14 (very basic); mayoria vinos en escala 3-4.(principalmente 3,55 a 4)
* **sulphates:** Actua como un antimicrobial and antioxidante. Los sulfatos de sodio y calcio aparecen en el agua y por lo tanto la uva y el vino pueden contenerlos. Un agua con una cantidad de sulfatos inferior a 250mg/l se considera en este aspecto un agua de calidad y con valores superiores a 400mg/l insalubre.

* **alcohol:** cantidad de alcohol del vino. No es muy útil para hallar la calidad
* **quality:** calidad del vino entre 0 y 10

## 1.1 ¿Por qué es importante y qué pregunta/problema pretende responder?

Pregunta: ¿Qué componentes fisico-químicos influyen en que un vino sea bueno?. Obtener un modelo cuya combinación de variables permita determinar si es un buen vino.


# 2. Integración y selección de los datos de interés a analizar.

La mayoría de los atributos corresponden con características necesarias para determinar la calidad del vino. 

Sin embargo, a priori, podemos prescindir de la variable `total sulfur dioxide` (indica elsuma de concentraciones libres y amarradas, solo nos interesan las libres) y `density` (indica proporción de alcohol y esta no es interesante para determinar la calidad) (Según el estudio de: https://www.vinopack.es/criterios-que-determinan-la-calidad-en-el-vino).

No obstante, en los siguientes apartados comprobaremos si esto es cierto, o por el contrario si que afecta en la calidad.

# 3 Limpieza de datos

## 3.1 Elementos vacíos
```{r}
# Números de valores desconocidos por campo
sapply(wine_red, function(x) sum(is.na(x)))
#No se han encontrado valores vacíos o NAs. 

# Resumen de las variables
summary(wine_red)
#ph: correcto (entre 2 y 4)
```

## 3.2 Valores extremos
Para cada una de las variables observemos si existen valores atípicos:

```{r}
boxplot(wine_red$fixed.acidity,main = "fixed.acidity",col="gray")
boxplot.stats(wine_red$fixed.acidity)$out

boxplot(wine_red$volatile.acidity,main = "volatile",col="gray")
boxplot.stats(wine_red$volatile.acidity)$out

boxplot(wine_red$citric.acid,main = "citric.acid",col="gray")
boxplot.stats(wine_red$citric.acid)$out

boxplot(wine_red$residual.sugar,main = "residual.sugar",col="gray")
boxplot.stats(wine_red$residual.sugar)$out

boxplot(wine_red$chlorides,main = "chlorides",col="gray")
boxplot.stats(wine_red$residual.sugar)$out

boxplot(wine_red$chlorides,main = "residual.sugar",col="gray")
boxplot.stats(wine_red$residual.sugar)$out

boxplot(wine_red$free.sulfur.dioxide,main = "free.sulfur.dioxide",col="gray")
boxplot.stats(wine_red$free.sulfur.dioxide)$out


boxplot(wine_red$pH,main = "pH",col="gray")
boxplot.stats(wine_red$pH)$out
#datos correctos porque los valores de pH estan entre 2 y 7

boxplot(wine_red$sulphates,main = "sulphates",col="gray")
boxplot.stats(wine_red$sulphates)$out


boxplot(wine_red$ alcohol,main = " alcohol",col="gray")
boxplot.stats(wine_red$ alcohol)$out
#alcohol está dentro de unos rangos adecuados

```

Todas las gráficas presentan outliers pero dado a que, la creación de un vino es puramente una reacción química, se puede decir que los valores que se presentan son posibles y simplemente podemos decir que dichos vinos tienen características muy diferentes al resto.

# 4. Análisis de datos.

## 4.1 Selección de los grupos de datos que se quieren analizar/comparar (planificación de los análisis a aplicar).

 Vamos a analizar si son significativas cada variable del dataset para ello haremos un test t con un nivel de significación=0.05.


 Diferentes hipótesis se pueden establecer cambiando el valor de parámetro alternative en la función t.test



 1. **Alternative='two.sided':** Hipótesis nula H0: $\mu{1}$ =  $\mu{2}$ Hipótesis alternativa H1:  $\mu{1}$ != $\mu{2}$
 2. **Alternative='greater':** Hipótesis nula H0: $\mu{1}$ =  $\mu{2}$ Hipótesis alternativa H1:  $\mu{1}$ > $\mu{2}$
 3. **Alternative='less':** Hipótesis nula H0: $\mu{1}$ =  $\mu{2}$ Hipótesis alternativa H1:  $\mu{1}$ < $\mu{2}$
```{r}

 # A más alcohol, hay más calidad, significativo

high_alcohol<-quantile(wine_red$alcohol, probs =0.75)
wine_red.altoAlcohol<-wine_red[wine_red$alcohol>=high_alcohol,]$quality
wine_red.bajoAlcohol<-wine_red[wine_red$alcohol<high_alcohol,]$quality

t.test(wine_red.altoAlcohol, wine_red$quality, alternative = "greater")
t.test(wine_red.bajoAlcohol, wine_red$quality, alternative = "less")

# A más azucar no hay más calidad y a menos azucar tampoco , no significativo porque no se rechaza la hipotesis

high_sugar<-quantile(wine_red$residual.sugar, probs =0.75)
wine_red.altoGradoAzucar<-wine_red[wine_red$residual.sugar>=high_sugar,]$quality
wine_red.bajoGradoAzucar<-wine_red[wine_red$residual.sugar<high_sugar,]$quality
t.test(wine_red.altoGradoAzucar, wine_red$quality, alternative = "greater")
t.test(wine_red.bajoGradoAzucar, wine_red$quality, alternative = "less")


#  Volatile.acidity, significativo
#Para un alto valor de acido volátil está claro que el vino no es mejor, es mejor el vino cuanto menos acido volátil hay

high_volatile.acidity<-quantile(wine_red$volatile.acidity, probs =0.75)
wine_red.altoVolatile.acidity<-wine_red[wine_red$volatile.acidity>=high_volatile.acidity,]$quality
wine_red.bajoVolatile.acidity<-wine_red[wine_red$volatile.acidity<high_volatile.acidity,]$quality

# Es significativo el nivel de volatile acidity
t.test(wine_red.altoVolatile.acidity, wine_red$quality, alternative = "less")
t.test(wine_red.bajoVolatile.acidity, wine_red$quality, alternative = "greater")


#sulphates, significativo

high_sulphates<-quantile(wine_red$volatile.acidity, probs =0.75)
wine_red.altoSulphates<-wine_red[wine_red$sulphates>=high_sulphates,]$quality
wine_red.bajoSulphates<-wine_red[wine_red$sulphates<high_sulphates,]$quality

t.test(wine_red.altoSulphates, wine_red$quality, alternative = "greater") # significativo sulfato alto
t.test(wine_red.bajoSulphates, wine_red$quality, alternative = "less") #


#PH, no significativo

high_pH<-quantile(wine_red$pH, probs =0.75)
wine_red.altopH<-wine_red[wine_red$pH>=high_pH,]$quality
wine_red.bajopH<-wine_red[wine_red$pH<high_pH,]$quality

t.test(wine_red.altopH, wine_red$quality, alternative = "greater") # NO significativo  PH
t.test(wine_red.bajopH, wine_red$quality, alternative = "less") # NO significativo  PH

# Citric acid es significativo
high_citric_acid<-quantile(wine_red$citric.acid, probs =0.75)
wine_red.altoCitricAcid<-wine_red[wine_red$citric.acid>=high_citric_acid,]$quality
wine_red.bajoCitricAcid<-wine_red[wine_red$citric.acid<high_citric_acid,]$quality

t.test(wine_red.altoCitricAcid, wine_red$quality, alternative = "greater")
t.test(wine_red.bajoCitricAcid, wine_red$quality, alternative = "less")

# fixed acidity es significativo
high_fixed_acidity<-quantile(wine_red$fixed.acidity, probs =0.75)
wine_red.altoFixedAcidity<-wine_red[wine_red$fixed.acidity>=high_fixed_acidity,]$quality
wine_red.bajoFixedAcidity<-wine_red[wine_red$fixed.acidity<high_fixed_acidity,]$quality

t.test(wine_red.altoFixedAcidity, wine_red$quality, alternative = "greater")
t.test(wine_red.bajoFixedAcidity, wine_red$quality, alternative = "less")


#Chlorides, significativo, a más chlorides peor calidad

high_chlorides<-quantile(wine_red$chlorides, probs =0.75)
wine_red.altoChlorides<-wine_red[wine_red$chlorides>=high_chlorides,]$quality
wine_red.bajoChlorides<-wine_red[wine_red$chlorides<high_chlorides,]$quality

t.test(wine_red.altoChlorides, wine_red$quality, alternative = "less")
t.test(wine_red.bajoChlorides, wine_red$quality, alternative = "greater")

#free sulfur dioxide, no significativo

high_free_sulfur<-quantile(wine_red$free.sulfur.dioxide, probs =0.75)
wine_red.altoFreeSulfur<-wine_red[wine_red$free.sulfur.dioxide>=high_free_sulfur,]$quality
wine_red.bajoFreeSulfur<-wine_red[wine_red$free.sulfur.dioxide<high_free_sulfur,]$quality

t.test(wine_red.altoFreeSulfur, wine_red$quality, alternative = "greater")
t.test(wine_red.bajoFreeSulfur, wine_red$quality, alternative = "less")

# total sulfur dioxide,  significativo, a más cantidad de  total sulfur peor calidad

high_total_sulfur<-quantile(wine_red$total.sulfur.dioxide, probs =0.75)
wine_red.altoTotalSulfur<-wine_red[wine_red$total.sulfur.dioxide>=high_total_sulfur,]$quality
wine_red.bajoTotalSulfur<-wine_red[wine_red$total.sulfur.dioxide<high_total_sulfur,]$quality

t.test(wine_red.altoTotalSulfur, wine_red$quality, alternative = "less")
t.test(wine_red.bajoTotalSulfur, wine_red$quality, alternative = "greater")

# Density, significativo a mayor densidad peor calidad

high_density<-quantile(wine_red$density, probs =0.75)
wine_red.altoDensity<-wine_red[wine_red$density>=high_density,]$quality
wine_red.bajoDensity<-wine_red[wine_red$density<high_density,]$quality

t.test(wine_red.altoDensity, wine_red$quality, alternative = "less")
t.test(wine_red.bajoDensity, wine_red$quality, alternative = "greater")
```
**Las variables significativas son : alcohol , volatile.acidity , sulphates , citric.acid , fixed.acidity , chlorides , total.sulfur.dioxide , density**



## 4.2 Comprobación de la normalidad y homogeneidad de la varianza
**Comprobar  que variables siguen distribución normal**


Aplicando la siguiente función podemos comprobar si siguen una distribución normal o si por el contrario no lo hacen.

```{r}
#install.packages("nortest")
library(nortest)

alpha = 0.05
col.names = colnames(wine_red)
for (i in 1:ncol(wine_red)) {
  if (i == 1) cat("Variables que no siguen una distribución normal:\n")
  if (is.integer(wine_red[,i]) | is.numeric(wine_red[,i])) {
      p_val = ad.test(wine_red[,i])$p.value
        if (p_val < alpha) {
            cat(col.names[i])
                  # Format output
            if (i < ncol(wine_red) - 1) cat(", ")
            if (i %% 3 == 0) cat("\n") 
        }
      } 
  }
```


## 4.3 Aplicación de pruebas estadísticas para comparar los grupos de datos. En función de los datos y el objetivo del estudio, aplicar pruebas de contraste de hipótesis, correlaciones, regresiones, etc.

En primer lugar, procedemos a realizar un análisis de correlación entre las distintas variables para determinar cuáles de ellas ejercen una mayor influencia sobre la calidad del vino:


```{r}
corr_matrix <- matrix(nc = 2, nr = 0)
colnames(corr_matrix) <- c("estimate", "p-value")
# Calcular el coeficiente de correlación para cada variable cuantitativa # con respecto al campo "precio"
for (i in 1:(ncol(wine_red) - 1)) {
if (is.integer(wine_red[,i]) | is.numeric(wine_red[,i]))
    { 
    spearman_test = cor.test(wine_red[,i],wine_red[,length(wine_red)],method = "spearman")
      corr_coef = spearman_test$estimate
      p_val = spearman_test$p.value
      # Add row to matrix
    pair = matrix(ncol = 2, nrow = 1)
    pair[1][1] = corr_coef
    pair[2][1] = p_val
    corr_matrix <- rbind(corr_matrix, pair)
    rownames(corr_matrix)[nrow(corr_matrix)] <- colnames(wine_red)[i]
  } 
}

a <- corr_matrix[,'p-value']
corr_matrix[order(a),]
```

Así, identificamos cuáles son las variables más correlacionadas con la calidad según su proximidad con los valores -1 y +1.

Teniendo esto en cuenta, queda patente cómo la variable más relevante para **la calidad** es la variable `alcohol`. Pero en términos generales podemos decir que los valores que obtenemos son bastante modestos y no sería adecuado obtener ninguna conclusión por ahora. Lo único que podemos hacer es utilizar estos valores como tendencias.

Nota. Para cada coeficiente de correlación se muestra también su p-valor asociado, puesto que éste puede dar información acerca del peso estadístico de la correlación obtenida.

### Modelo de regresión lineal logística

Tal y como se planteó en los objetivos de la actividad, resultará de mucho interés poder realizar predicciones sobre la calidad del vino dadas sus características.
Así, se calculará un modelo de regresión lógistica utilizando regresores tanto cuantitativos como cualitativos con el que poder realizar las predicciones sobre la calidad.

**Se usa regresión logística ya que nuestro modelo predicirá si el vino es de calidad o no (variable dicotómica).**

Para obtener un modelo de regresión logística considerablemente eficiente, lo que haremos será obtener varios modelos de regresión utilizando las variables que estén más correladas con respecto a la calidad.



```{r}

# Regresores cuantitativos con mayor coeficiente  de correlación con respecto al precio
alcohol = wine_red$alcohol
volatile.acidity = wine_red$volatile.acidity
sulphates=wine_red$sulphates
citric.acid=wine_red$citric.acid
total.sulfur.dioxide=wine_red$total.sulfur.dioxide
chlorides=wine_red$chlorides
density=wine_red$density
fixed.acidity=wine_red$fixed.acidity
free.sulfur.dioxide=wine_red$free.sulfur.dioxide  
pH=wine_red$pH

good_wine <-ifelse(test=wine_red$quality>=7,yes=1,no=0)
wine_red$good_wine=good_wine
quality<- wine_red$quality

library(InformationValue)
# El modelo 1 usa las variables que hemos detectado como significativas según el test t para un valor significación=0.05
#El modelo 2 usa todas las variables
GLM.1 <- glm( wine_red$good_wine ~ alcohol + volatile.acidity + sulphates + citric.acid + fixed.acidity + chlorides + total.sulfur.dioxide + density, family=binomial(logit),data=wine_red)
AIC_GLM1<-summary(GLM.1)$aic

GLM.2 <- glm( wine_red$good_wine ~ . -quality , family=binomial(logit),data=wine_red)
AIC_GLM2<-summary(GLM.2)$aic

AIC_GLM1
AIC_GLM2
p_model1 <- predict(GLM.1, type = 'response')
p_model2 <- predict(GLM.2, type = 'response')
wine_red$prob<-p_model1
wine_red$prob2<-p_model2

confusionMatrix(wine_red$good_wine,p_model1,0.7)
confusionMatrix(wine_red$good_wine,p_model2,0.7)
```
El mejor modelo, el número 2 que usa todas las variables, aunque no mejora demasiado respecto al modelo 1: AIC_GLM1=898.8508 AIC_GLM2=894.8644



# 5. Representación de los resultados a partir de tablas y gráficas.

### Calculo curva ROC


```{r}

library(pROC)
#Cáculo curva
g<-roc(wine_red$good_wine,wine_red$prob2)
g
#Área bajo la curva
auc(g)
plot(g) 
```




