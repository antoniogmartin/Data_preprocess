---
title: 'Tipología y ciclo de vida de los datos: Práctica2'
author: "Antonio Guzmán Martín"
date: "Diciembre 2017"
output:
  pdf_document:
    toc: yes
    toc_depth: '2'
  html_document:
    highlight: default
    number_sections: yes
    theme: cosmo
    toc: yes
    toc_depth: 2
---

```{r}
library(readr)
redwine <- read.csv(file="winequality-red.csv", header = TRUE)

#numero de filas por dataset
nrow(redwine)
ncol<-ncol(redwine)
#sacamos 5 primeras filas
head(redwine[,1:ncol])

sapply(redwine,class)
```
# 1. Descripción del dataset


**Variables del dataset**


* **fixed acidity:** Conjunto de los ácidos naturales procedentes de la uva (tartárico, málico, cítrico y succínico) o formados en la fermentación maloláctica (láctico). En general, los ácidos (acidez fija) son preservante naturales del vino y ayuda a mantener el color y cualidades aromáticas. 

* **volatile acidity:** Conjunto de ácidos formados durante la fermentación o como consecuencia de alteraciones microbianas. Estos ácidos son, principalmente: ácido Acético, ácido Propionico, ácido Butírico y ácido Sulfúrico. Si la acidez volátil, presente en todos los vinos, es muy elevada el vino se picará y avigranará con el paso del tiempo. Es conveniente que la acidez volatil de un vino sea lo más baja posible.

El contenido en acidez volátil no puede ser superior a:
a) 18 miliequivalentes por litro para los mostos de uva parcialmente fermentados,
b) 18 miliequivalentes por litro para los vinos blancos y rosados,
c) 20 miliequivalentes por litro para los vinos tintos.


* **citric acid:** En pequeñas cantidades este hacido puede añadir frescor y sabor a los vinos (dentro de acido fijo)

* **residual sugar:** Azúcar que queda en el vino después de la fermentación. Es raro encontrar vinos con menos de  1 g/l y vinos con más de  45 g/l son considerados dulces
* **chlorides:** cantidad de sal en el vino
* **free sulfur dioxide :** Previene del crecimiento microbial y de la oxidación del vino.La oxidación enturbia sus colores característicos (tornándolos en amarillos intensos e, incluso, marrones).Por lo que respecta al gusto, al beberlo notaremos sabores más secos y ásperos, incluso amargos en algunos casos.

* **total sulfur dioxide:** suma de concentraciones libres y amarradas de S02; concentraciones de dioxodo de sulfuro libres superiores a  50 ppm se vuelven evidentes en el sabor y olor
* **density:** densidad del vino, suele ser similar al del agua dependiendo de la concentración de azucar y alcohol
* **pH:** Describe como de ácido o básico es el vino 0 (very acidic) to 14 (very basic); mayoria vinos en escala 3-4.(principalmente 3,55 a 4)
* **sulphates:** Actua como un antimicrobial and antioxidante. Los sulfatos de sodio y calcio aparecen en el agua y por lo tanto la uva y el vino pueden contenerlos. Un agua con una cantidad de sulfatos inferior a 250mg/l se considera en este aspecto un agua de calidad y con valores superiores a 400mg/l insalubre.

* **alcohol:** cantidad de alcohol del vino. No es muy útil para hallar la calidad
* **quality:** calidad del vino entre 0 y 10

## 1.1 ¿Por qué es importante y qué pregunta/problema pretende responder?

Pregunta: ¿Qué componentes fisico-químicos influyen en que un vino sea bueno?. Obtener un modelo cuya combinación de variables permita determinar si es un buen vino.


# 2. Integración y selección de los datos de interés a analizar.

La mayoría de los atributos corresponden con características necesarias para determinar la calidad del vino. 

Sin embargo, a priori, podemos prescindir de la variable `total sulfur dioxide` (indica elsuma de concentraciones libres y amarradas, solo nos interesan las libres) y `density` (indica proporción de alcohol y esta no es interesante para determinar la calidad) (Según el estudio de: https://www.vinopack.es/criterios-que-determinan-la-calidad-en-el-vino).

No obstante, en los siguientes apartados comprobaremos si esto es cierto, o por el contrario si que afecta en la calidad.

# 3 Limpieza de datos

## 3.1 Elementos vacíos
```{r}
# Números de valores desconocidos por campo
sapply(redwine, function(x) sum(is.na(x)))
#No se han encontrado valores vacíos o NAs. 

# Resumen de las variables
summary(redwine)
#ph: correcto (entre 2 y 4)
```

## 3.2 Valores extremos
Para cada una de las variables observemos si existen valores atípicos:

```{r}
boxplot(redwine$fixed.acidity,main = "fixed.acidity",col="gray")
boxplot.stats(redwine$fixed.acidity)$out

boxplot(redwine$volatile.acidity,main = "volatile",col="gray")
boxplot.stats(redwine$volatile.acidity)$out

boxplot(redwine$citric.acid,main = "citric.acid",col="gray")
boxplot.stats(redwine$citric.acid)$out

boxplot(redwine$residual.sugar,main = "residual.sugar",col="gray")
boxplot.stats(redwine$residual.sugar)$out

boxplot(redwine$chlorides,main = "chlorides",col="gray")
boxplot.stats(redwine$residual.sugar)$out

boxplot(redwine$chlorides,main = "residual.sugar",col="gray")
boxplot.stats(redwine$residual.sugar)$out

boxplot(redwine$free.sulfur.dioxide,main = "free.sulfur.dioxide",col="gray")
boxplot.stats(redwine$free.sulfur.dioxide)$out


boxplot(redwine$pH,main = "pH",col="gray")
boxplot.stats(redwine$pH)$out
#datos correctos porque los valores de pH estan entre 2 y 7

boxplot(redwine$sulphates,main = "sulphates",col="gray")
boxplot.stats(redwine$sulphates)$out


boxplot(redwine$ alcohol,main = " alcohol",col="gray")
boxplot.stats(redwine$ alcohol)$out
#alcohol está dentro de unos rangos adecuados

```

Todas las gráficas presentan outliers pero dado a que, la creación de un vino es puramente una reacción química, se puede decir que los valores que se presentan son posibles y simplemente podemos decir que dichos vinos tienen características muy diferentes al resto.

# 4. Análisis de datos.

## 4.1 Selección de los grupos de datos que se quieren analizar/comparar (planificación de los análisis a aplicar).

Vamos a proceder a realizar 3 grupos. Un primer grupo de alto y bajo contenido de alcohol, otro segundo grupo de vinos más dulces y menos dulces y un último grupo de acidez volátil.

A continuación creamos la partición a partir del tercer cuartil de la variable `alcohol`:

```{r}
high_alcohol<-quantile(redwine$alcohol, probs =0.75)
vinos.altoAlcohol<-redwine[redwine$alcohol>=high_alcohol,]$quality
vinos.bajoAlcohol<-redwine[redwine$alcohol<high_alcohol,]$quality
```

Variable `residual.sugar`:

```{r}
high_sugar<-quantile(redwine$residual.sugar, probs =0.75)
vinos.altoGradoAzucar<-redwine[redwine$residual.sugar>=high_sugar,]$quality
vinos.bajoGradoAzucar<-redwine[redwine$residual.sugar<high_sugar,]$quality
```

Y finalmente, `volatile.acidity`:

```{r}
high_volatile.acidity<-quantile(redwine$volatile.acidity, probs =0.75)
vinos.altoVolatile.acidity<-redwine[redwine$volatile.acidity>=high_volatile.acidity,]$quality
vinos.bajoVolatile.acidity<-redwine[redwine$volatile.acidity<high_volatile.acidity,]$quality
```


## 4.2 Comprobación de la normalidad y homogeneidad de la varianza
**Comprobar  que variables siguen distribución normal**

Aplicando la siguiente función podemos comprobar si siguen una distribución normal o si por el contrario no lo hacen.

```{r}
#install.packages("nortest")
library(nortest)

alpha = 0.05
col.names = colnames(redwine)
for (i in 1:ncol(redwine)) {
  if (i == 1) cat("Variables que no siguen una distribución normal:\n")
  if (is.integer(redwine[,i]) | is.numeric(redwine[,i])) {
      p_val = ad.test(redwine[,i])$p.value
        if (p_val < alpha) {
            cat(col.names[i])
                  # Format output
            if (i < ncol(redwine) - 1) cat(", ")
            if (i %% 3 == 0) cat("\n") 
        }
      } 
  }
```

Otra alternativa es aplicar la función *shapiro.test* y a partir del valor obtenido de p-valor podremos decir si es normal o no.

```{r}
shapiro.test(redwine$fixed.acidity)
shapiro.test(redwine$volatile.acidity)
shapiro.test(redwine$citric.acid)
shapiro.test(redwine$residual.sugar)
shapiro.test(redwine$chlorides)
shapiro.test(redwine$free.sulfur.dioxide)
shapiro.test(redwine$total.sulfur.dioxide)
shapiro.test(redwine$density)
shapiro.test(redwine$pH)
shapiro.test(redwine$sulphates)
shapiro.test(redwine$alcohol)
```

Como el p-valor es inferior al 0.05 podemos rechazar la hipótesis nula y decir que no se aproxima a una distribución normal.


## 4.3 Aplicación de pruebas estadísticas para comparar los grupos de datos. En función de los datos y el objetivo del estudio, aplicar pruebas de contraste de hipótesis, correlaciones, regresiones, etc.

En primer lugar, procedemos a realizar un análisis de correlación entre las distintas variables para determinar cuáles de ellas ejercen una mayor influencia sobre la calidad del vino:


```{r}
corr_matrix <- matrix(nc = 2, nr = 0)
colnames(corr_matrix) <- c("estimate", "p-value")
# Calcular el coeficiente de correlación para cada variable cuantitativa # con respecto al campo "precio"
for (i in 1:(ncol(redwine) - 1)) {
if (is.integer(redwine[,i]) | is.numeric(redwine[,i]))
    { 
    spearman_test = cor.test(redwine[,i],redwine[,length(redwine)],method = "spearman")
      corr_coef = spearman_test$estimate
      p_val = spearman_test$p.value
      # Add row to matrix
    pair = matrix(ncol = 2, nrow = 1)
    pair[1][1] = corr_coef
    pair[2][1] = p_val
    corr_matrix <- rbind(corr_matrix, pair)
    rownames(corr_matrix)[nrow(corr_matrix)] <- colnames(redwine)[i]
  } 
}

a <- corr_matrix[,'p-value']
corr_matrix[order(a),]
```

Así, identificamos cuáles son las variables más correlacionadas con la calidad según su proximidad con los valores -1 y +1.

Teniendo esto en cuenta, queda patente cómo la variable más relevante para **la calidad** es la variable `alcohol`. Pero en términos generales podemos decir que los valores que obtenemos son bastante modestos y no sería adecuado obtener ninguna conclusión por ahora. Lo único que podemos hacer es utilizar estos valores como tendencias.

```{r}
#install.packages("corrplot")
library(corrplot)
corrplot(cor(redwine))
```
*Nota: Para cada coeficiente de correlación se muestra también su p-valor asociado, puesto que éste puede dar información acerca del peso estadístico de la correlación obtenida.*


### ¿Qué variables pueden influir más en la calidad de un vino?

Utilizando la división de los diferentes grupos que se ha realizado en el apartado 4.1, vamos a realizar un contraste de hipótesis para conocer si altos valores de una variable afectan a la calidad final del vino.

#### ¿A mayor alcohol mayor calidad?

Tomando aquellos vinos con nivel de alcohol superior al tercer cuartil aplicamos el siguiente contraste de hipótesis, que no influya y por tanto permanezca igual o por el contrario que si influya y la calidad sea mayor:

$H_0: \mu_0 - \mu_1  = 0$
$H_1 : \mu_0 - \mu_1 < 0$
Donde $\mu_0$ es la primera muestra de altos contenidos y $\mu_1$ la segunda muestra de bajos contenidos.

```{r}
t.test(vinos.altoAlcohol, vinos.bajoAlcohol)
```

Para el alcohol obtenemos que *p-valor* es menor que 0.05 por lo que rechazamos la hipótesis nula y podemos decir que para altos valores de alcohol mejora la calidad.

```{r}
t.test(vinos.altoGradoAzucar, vinos.bajoGradoAzucar)
```
Sin embargo con el azucar ocurre lo contrario y no podemos rechazar la hipótesis nula.


```{r}
t.test(vinos.altoVolatile.acidity, vinos.bajoVolatile.acidity)
```

Para la `acidez` ocurre lo mismo que para el `alcohol`, podemos rechazar la hipótesis nula y decir que a mayor acidez mejor calidad.

### Modelo de regresión lineal logística
Para realizar predicciones en la calidad del vino vamos a plantear un modelo de regresión logística en dónde solamente tendremos regresores cuantitativos. La variable a predecir será una variable dicotómica transformada previamente (`Binary.quality`esta tomará valores de calidad *0* si es menor que 7 ó *1* en caso contrario).

```{r}
# Regresores cuantitativos con mayor coeficiente  de correlación con respecto al precio
redwine$Binary.quality <-ifelse(test=redwine$quality>=7,yes=1,no=0)

modelo.logistico.1 <- glm(Binary.quality ~ alcohol + volatile.acidity,data=redwine)
exp(coefficients(modelo.logistico.1))

modelo.logistico.2 <- glm(Binary.quality ~ alcohol + volatile.acidity + fixed.acidity,data=redwine)

modelo.logistico.3 <- glm(Binary.quality ~ alcohol + volatile.acidity + fixed.acidity + free.sulfur.dioxide ,data=redwine)

modelo.logistico.4 <- glm(Binary.quality ~ alcohol + volatile.acidity + fixed.acidity + free.sulfur.dioxide + sulphates,data=redwine)

modelo.logistico.5 <- glm(Binary.quality ~ fixed.acidity + citric.acid + free.sulfur.dioxide+ total.sulfur.dioxide + density,data=redwine)
summary(modelo.logistico.5)

AIC(modelo.logistico.1, modelo.logistico.2, modelo.logistico.3, modelo.logistico.4)

```

```{r}
predicciones <- ifelse(test = modelo.logistico.4$fitted.values > 0.7, yes = 1, no = 0)
matriz_confusion <- table(modelo.logistico.4$model$Binary.quality, predicciones,
                          dnn = c("observaciones", "predicciones"))

print(matriz_confusion)
```

```{r}
library(pROC)
roc_curve = roc(redwine$Binary.quality, predicciones, AUC = TRUE, ci = TRUE)

plot.roc(roc_curve, legacy.axes = TRUE, print.thres = "best", print.auc = TRUE, auc.polygon = FALSE, col = 2, grid = TRUE)
```